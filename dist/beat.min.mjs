var Tt=Object.create;var lt=Object.defineProperty;var Mt=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames;var bt=Object.getPrototypeOf,It=Object.prototype.hasOwnProperty;var Dt=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var Ct=(n,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Rt(t))!It.call(n,r)&&r!==e&&lt(n,r,{get:()=>t[r],enumerable:!(o=Mt(t,r))||o.enumerable});return n};var Vt=(n,t,e)=>(e=n!=null?Tt(bt(n)):{},Ct(t||!n||!n.__esModule?lt(e,"default",{value:n,enumerable:!0}):e,n));var pt=Dt((zt,ht)=>{"use strict";function w(n){if(this.size=n|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=n<<1;for(var t=new Array(this.size*2),e=0;e<t.length;e+=2){let c=Math.PI*e/this.size;t[e]=Math.cos(c),t[e+1]=-Math.sin(c)}this.table=t;for(var o=0,r=1;this.size>r;r<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var a=0;a<this._width;a+=2){var i=this._width-a-2;this._bitrev[s]|=(s>>>a&3)<<i}}this._out=null,this._data=null,this._inv=0}ht.exports=w;w.prototype.fromComplexArray=function(t,e){for(var o=e||new Array(t.length>>>1),r=0;r<t.length;r+=2)o[r>>>1]=t[r];return o};w.prototype.createComplexArray=function(){let t=new Array(this._csize);for(var e=0;e<t.length;e++)t[e]=0;return t};w.prototype.toComplexArray=function(t,e){for(var o=e||this.createComplexArray(),r=0;r<o.length;r+=2)o[r]=t[r>>>1],o[r+1]=0;return o};w.prototype.completeSpectrum=function(t){for(var e=this._csize,o=e>>>1,r=2;r<o;r+=2)t[e-r]=t[r],t[e-r+1]=-t[r+1]};w.prototype.transform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._transform4(),this._out=null,this._data=null};w.prototype.realTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._realTransform4(),this._out=null,this._data=null};w.prototype.inverseTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=1,this._transform4();for(var o=0;o<t.length;o++)t[o]/=this.size;this._out=null,this._data=null};w.prototype._transform4=function(){var t=this._out,e=this._csize,o=this._width,r=1<<o,s=e/r<<1,a,i,c=this._bitrev;if(s===4)for(a=0,i=0;a<e;a+=s,i++){let f=c[i];this._singleTransform2(a,f,r)}else for(a=0,i=0;a<e;a+=s,i++){let f=c[i];this._singleTransform4(a,f,r)}var l=this._inv?-1:1,p=this.table;for(r>>=2;r>=2;r>>=2){s=e/r<<1;var u=s>>>2;for(a=0;a<e;a+=s)for(var m=a+u,g=a,v=0;g<m;g+=2,v+=r){let f=g,h=f+u,d=h+u,y=d+u,F=t[f],T=t[f+1],A=t[h],x=t[h+1],M=t[d],R=t[d+1],b=t[y],I=t[y+1],D=F,C=T,V=p[v],E=l*p[v+1],W=A*V-x*E,U=A*E+x*V,G=p[2*v],j=l*p[2*v+1],H=M*G-R*j,X=M*j+R*G,$=p[3*v],J=l*p[3*v+1],K=b*$-I*J,Q=b*J+I*$,Y=D+H,B=C+X,z=D-H,Z=C-X,S=W+K,N=U+Q,P=l*(W-K),k=l*(U-Q),q=Y+S,L=B+N,O=Y-S,tt=B-N,et=z+k,rt=Z-P,nt=z-k,ot=Z+P;t[f]=q,t[f+1]=L,t[h]=et,t[h+1]=rt,t[d]=O,t[d+1]=tt,t[y]=nt,t[y+1]=ot}}};w.prototype._singleTransform2=function(t,e,o){let r=this._out,s=this._data,a=s[e],i=s[e+1],c=s[e+o],l=s[e+o+1],p=a+c,u=i+l,m=a-c,g=i-l;r[t]=p,r[t+1]=u,r[t+2]=m,r[t+3]=g};w.prototype._singleTransform4=function(t,e,o){let r=this._out,s=this._data,a=this._inv?-1:1,i=o*2,c=o*3,l=s[e],p=s[e+1],u=s[e+o],m=s[e+o+1],g=s[e+i],v=s[e+i+1],f=s[e+c],h=s[e+c+1],d=l+g,y=p+v,F=l-g,T=p-v,A=u+f,x=m+h,M=a*(u-f),R=a*(m-h),b=d+A,I=y+x,D=F+R,C=T-M,V=d-A,E=y-x,W=F-R,U=T+M;r[t]=b,r[t+1]=I,r[t+2]=D,r[t+3]=C,r[t+4]=V,r[t+5]=E,r[t+6]=W,r[t+7]=U};w.prototype._realTransform4=function(){var t=this._out,e=this._csize,o=this._width,r=1<<o,s=e/r<<1,a,i,c=this._bitrev;if(s===4)for(a=0,i=0;a<e;a+=s,i++){let st=c[i];this._singleRealTransform2(a,st>>>1,r>>>1)}else for(a=0,i=0;a<e;a+=s,i++){let st=c[i];this._singleRealTransform4(a,st>>>1,r>>>1)}var l=this._inv?-1:1,p=this.table;for(r>>=2;r>=2;r>>=2){s=e/r<<1;var u=s>>>1,m=u>>>1,g=m>>>1;for(a=0;a<e;a+=s)for(var v=0,f=0;v<=g;v+=2,f+=r){var h=a+v,d=h+m,y=d+m,F=y+m,T=t[h],A=t[h+1],x=t[d],M=t[d+1],R=t[y],b=t[y+1],I=t[F],D=t[F+1],C=T,V=A,E=p[f],W=l*p[f+1],U=x*E-M*W,G=x*W+M*E,j=p[2*f],H=l*p[2*f+1],X=R*j-b*H,$=R*H+b*j,J=p[3*f],K=l*p[3*f+1],Q=I*J-D*K,Y=I*K+D*J,B=C+X,z=V+$,Z=C-X,S=V-$,N=U+Q,P=G+Y,k=l*(U-Q),q=l*(G-Y),L=B+N,O=z+P,tt=Z+q,et=S-k;if(t[h]=L,t[h+1]=O,t[d]=tt,t[d+1]=et,v===0){var rt=B-N,nt=z-P;t[y]=rt,t[y+1]=nt;continue}if(v!==g){var ot=Z,mt=-S,vt=B,ft=-z,gt=-l*q,dt=-l*k,_t=-l*P,yt=-l*N,wt=ot+gt,xt=mt+dt,Ft=vt+yt,At=ft-_t,at=a+m-v,it=a+u-v;t[at]=wt,t[at+1]=xt,t[it]=Ft,t[it+1]=At}}}};w.prototype._singleRealTransform2=function(t,e,o){let r=this._out,s=this._data,a=s[e],i=s[e+o],c=a+i,l=a-i;r[t]=c,r[t+1]=0,r[t+2]=l,r[t+3]=0};w.prototype._singleRealTransform4=function(t,e,o){let r=this._out,s=this._data,a=this._inv?-1:1,i=o*2,c=o*3,l=s[e],p=s[e+o],u=s[e+i],m=s[e+c],g=l+u,v=l-u,f=p+m,h=a*(p-m),d=g+f,y=v,F=-h,T=g-f,A=v,x=h;r[t]=d,r[t+1]=0,r[t+2]=y,r[t+3]=F,r[t+4]=T,r[t+5]=0,r[t+6]=A,r[t+7]=x}});var Et={pcm8:(n,t,e,o,r)=>{let s=new Uint8Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c){let l=s[a++]-128;e[c][i]=l<0?l/128:l/127}},pcm16:(n,t,e,o,r)=>{let s=new Int16Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c){let l=s[a++];e[c][i]=l<0?l/32768:l/32767}},pcm24:(n,t,e,o,r)=>{let s=new Uint8Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c){let l=s[a++],p=s[a++],u=s[a++],m=l+(p<<8)+(u<<16),g=m>8388608?m-16777216:m;e[c][i]=g<0?g/8388608:g/8388607}},pcm32:(n,t,e,o,r)=>{let s=new Int32Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c){let l=s[a++];e[c][i]=l<0?l/2147483648:l/2147483647}},pcm32f:(n,t,e,o,r)=>{let s=new Float32Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c)e[c][i]=s[a++]},pcm64f:(n,t,e,o,r)=>{let s=new Float64Array(n,t),a=0;for(let i=0;i<r;++i)for(let c=0;c<o;++c)e[c][i]=s[a++]}};function Wt(n,t,e){let o="pcm"+t+(e?"f":""),r=n[o];if(!r)throw new TypeError("Unsupported data format: "+o);return r}function ct(n){let t=0,e=0;n.buffer?(t=n.byteOffset,e=n.length,n=n.buffer):(t=0,e=n.byteLength);let o=new DataView(n);function r(){let l=o.getUint8(t);return t++,l}function s(){let l=o.getUint16(t,!0);return t+=2,l}function a(){let l=o.getUint32(t,!0);return t+=4,l}function i(l){let p="";for(let u=0;u<l;++u)p+=String.fromCharCode(r());return p}if(i(4)!=="RIFF")throw new TypeError("Invalid WAV file");if(a(),i(4)!=="WAVE")throw new TypeError("Invalid WAV file");let c;for(;t<e;){let l=i(4),p=a(),u=t+p;switch(l){case"fmt ":let m=s();if(m!==1&&m!==3&&m!==65534)throw new TypeError(`Unsupported format in WAV file: ${m.toString(16)}`);c={format:"lpcm",floatingPoint:m===3,channels:s(),sampleRate:a(),byteRate:a(),blockSize:s(),bitDepth:s()};break;case"data":if(!c)throw new TypeError('Missing "fmt " chunk.');let g=Math.floor(p/c.blockSize),v=c.channels,f=c.sampleRate,h=[];for(let d=0;d<v;++d)h[d]=new Float32Array(g);return Wt(Et,c.bitDepth,c.floatingPoint)(n,t,h,v,g),{sampleRate:f,channelData:h};break}t=u}}var ut=Vt(pt(),1),_=class{constructor(t){typeof t=="string"&&(t=Buffer.from(t,"base64"));let e=ct(t);this.sampleData=e.channelData.map(o=>Array.prototype.slice.call(o)),this.sampleSize=e.channelData[0].length,this.sampleRate=e.sampleRate,this.duration=e.channelData[0].length/e.sampleRate}};_.prototype.getTime=function(n){return n/this.sampleRate};_.prototype.getMinVolumeWithIndex=function(n,t,e){let o=Number.MAX_SAFE_INTEGER,r=-1;for(let s=t;s<e;s++)o>this.sampleData[n][s]&&(o=this.sampleData[n][s],r=s);return{index:r,volume:o}};_.prototype.getMaxVolumeWithIndex=function(n,t,e){let o=Number.MIN_SAFE_INTEGER,r=-1;for(let s=t;s<e;s++)o<this.sampleData[n][s]&&(o=this.sampleData[n][s],r=s);return{index:r,volume:o}};_.prototype.getRMSVolumeWithIndex=function(n,t,e){let o=0;for(let r=t;r<e;r++)o+=Math.pow(this.sampleData[n][r],2);return{index:Math.floor((t+e)*.5),volume:Math.sqrt(o/this.sampleSize)}};_.prototype.getMinVolume=function(n,t,e){return _.prototype.getMinVolumeWithIndex(n,t,e).volume};_.prototype.getMaxVolume=function(n,t,e){return _.prototype.getMaxVolumeWithIndex(n,t,e).volume};_.prototype.getRMSVolume=function(n,t,e){return _.prototype.getRMSVolumeWithIndex(n,t,e).volume};_.prototype.getFrames=function(n){n||(n=this.sampleRate),n=Math.floor(n);let t=Math.ceil(this.sampleSize/n),e=[];for(let o=0;o<t;o++){let r=o*n,s=Math.min(this.sampleSize,o*n+n);e.push({start:r,end:s})}return e};_.prototype.getBeatsWithVolume=function(n,t,e){e||(e=this.getMaxVolumeWithIndex.bind(this));let o=this.getFrames(t),r=[];for(let s=0;s<o.length;s++){let{start:a,end:i}=o[s];r.push(e(n,a,i))}return r};_.prototype.getBeats=function(n,t,e){return this.getBeatsWithVolume(n,t,e).map(o=>o.index)};_.prototype.getBeatsWithFFT=function(n,t,e,o,r){t||(t=512),e||(e=1.2),o||(o=40),r||(r=8);let s=[],a=[],i=new ut.default(t),c=this.sampleData[n];for(let l=0;l<c.length;l+=t){let p=c.slice(l,l+t);if(p.length<t)break;let u=i.createComplexArray();i.realTransform(u,p);let m=[];for(let h=0;h<u.length;h+=2)m.push(Math.sqrt(u[h]*u[h]+u[h+1]*u[h+1]));let g=0;for(let h=0;h<o;h++)g+=m[h];s.push(g);let v=0,f=0;for(let h=Math.max(0,s.length-1-r);h<s.length;h++)v+=s[h],f++;v/=f,g>v*e&&a.push(l)}return a};_.prototype.getTemposWithCount=function(n){let t=[];for(let e=0;e<n.length;e++){let o=Math.min(e+10,n.length);for(let r=e+1;r<o;r++){let s=n[e],a=n[r],i=this.sampleRate*60/(a-s);for(;i<90;)i*=2;for(;i>180;)i/=2;i=Math.round(i);let c=t.find(l=>l.tempo===i);c?c.count+=1:t.push({tempo:i,count:1})}}return t.sort((e,o)=>o.count-e.count)};_.prototype.getTempos=function(n){return this.getTemposWithCount(n).map(t=>t.tempo)};export{_ as Beat};
