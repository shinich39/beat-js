import { Beat } from "../dist/beat.mjs";
import path from "node:path";
import fs from "node:fs";

;(async () => {
  const buffer = fs.readFileSync(path.join("./test/test.wav"));
  const b = new Beat(buffer);

  const channel = 0;
  const step = b.sampleRate * 0.2;
  const peaks = b.getPeaks(channel, step);
  console.log(`Peaks(${peaks.length})`, peaks);
  // Peaks(60) [
  //     6450,  17431,  23049,  34151,  40030,  50550,
  //   56116,  67149,  70580,  79971,  89169, 100216,
  //   111249, 122182, 128230, 138750, 144316, 155349,
  //   158780, 168005, 177376, 188336, 199577, 210386,
  //   215930, 226956, 232436, 243677, 247014, 255807,
  //   265576, 276536, 287777, 298586, 304131, 315156,
  //   320636, 331877, 335214, 344005, 359629, 365828,
  //   377761, 387203, 392577, 403349, 410095, 415468,
  //   423549, 438391, 444495, 454618, 460237, 471062,
  //   476499, 491802, 497200, 503936, 512030, 521511
  // ]

  const beats = b.getBeats(channel);
  console.log(`Beats(${beats.length})`, beats);
  // Beats(154) [
  //     0,   2048,   6144,   8192,  12288,  14336,  16384,  18432,
  // 22528,  24576,  28672,  30720,  32768,  34816,  38912,  40960,
  // 49152,  51200,  53248,  55296,  57344,  61440,  63488,  67584,
  // 69632,  88064,  90112,  94208,  96256, 100352, 102400, 104448,
  // 106496, 110592, 112640, 116736, 118784, 120832, 122880, 126976,
  // 129024, 137216, 139264, 141312, 143360, 145408, 149504, 151552,
  // 155648, 157696, 176128, 178176, 182272, 184320, 188416, 190464,
  // 192512, 194560, 198656, 200704, 204800, 206848, 208896, 210944,
  // 212992, 215040, 217088, 227328, 229376, 231424, 233472, 237568,
  // 239616, 243712, 245760, 264192, 266240, 270336, 272384, 276480,
  // 278528, 280576, 282624, 284672, 286720, 288768, 292864, 294912,
  // 299008, 301056, 303104, 305152, 315392, 317440, 319488, 321536,
  // 325632, 327680, 331776, 333824,
  // ... 54 more items
  // ]
  
  const time = b.getTime(beats[0]);
  console.log(time);
  // 0.14625850340136054

  let tempos = b.getTempos(peaks);
  console.log("Tempos from peaks", tempos);
  // [
  //   120, 160,  96, 137, 148, 107, 144, 121, 119, 159, 118,
  //   161, 173, 128, 135, 164, 132, 103,  92, 109, 174, 156,
  //   ...
  // ]

  // tempos = b.getTempos(beats);
  // console.log("Tempos from beats", tempos);
  
  const temp = tempos[0];
  console.log(temp);
  // 120


})();